pipeline {
    agent {
        label 'docker'
    } 
    environment {
        ANDROID_HOME = tool name: 'androidSdk'
    }
    tools {
       gradle "gradle562"
    }
     options {
        // Stop the build early in case of compile or test failures
        skipStagesAfterUnstable()
    }
    stages
    {

        stage("Build")
        {
            steps{
                sh '''gradle --version'''
                sh './gradlew clean' //run a gradle task
                echo "The build stage passed..."
            }
        }
        stage("test") {
            steps{
                echo "Gradle Tests..."
                sh './gradlew tasks'
                echo "The test stage passed..."
            }
        }    
        // stage('Compile') {
        //     steps {
        //       // Compile the app and its dependencies
        //       sh './gradlew compileDebugSources --stacktrace'
        //     }
        // }
        stage('Static analysis') {
            steps {
        // Run Lint and analyse the results
                sh './gradlew lintDebug'
                androidLint pattern: '**/lint-results-*.xml'
            }
        }
        // stage("ASSEMBLE") {
        //     steps{
        //         echo "Assemble"
        //         sh './gradlew assemble' //run a gradle task

        //     }
        // }
        // stage('Deploy') {
            // steps {
            //   script {                                                        
                // if (currentBuild.result == null         
                    // || currentBuild.result == 'SUCCESS') {  
                //    if(env.BRANCH_NAME ==~ /master/) {
                    //  Deploy when the committed branch is master (we use fastlane to complete this)     
                        //  sh 'fastlane app_deploy' 
                    // }
                //   }
                // }
            // }
        // }
        // post {
            // always {
            //   archiveArtifacts(allowEmptyArchive: true, artifacts: 'app/build/outputs/apk/production/release/*.apk')      // And kill the emulator?
            //   sh 'adb emu kill'
            // }
        // }
        // stage("Signing APK"){
            // steps{
                // gradle {
                    // rootBuildScriptDir 'myApp'
                    // useWrapper true
                    // tasks 'clean assembleRelease'
                // }
                // echo "Signing APK"
                // withCredentials([certificate(aliasVariable: 'MulticertCertificate', credentialsId: 'certificate_P12_ID', keystoreVariable: 'certificate_content', passwordVariable: 'certificate_password')]) {
                    // signAndroidApks (
                        // keyStoreId: "myApp.signerKeyStore",
                        // keyAlias: "myTeam",
                        // apksToSign: "**/*-unsigned.apk"
                        // uncomment the following line to output the signed APK to a separate directory as described above
                        // signedApkMapping: [ $class: UnsignedApkBuilderDirMapping ]
                        // uncomment the following line to output the signed APK as a sibling of the unsigned APK, as described above, or just omit signedApkMapping
                        // you can override these within the script if necessary
                        // androidHome: env.ANDROID_HOME
                        // zipalignPath: env.ANDROID_ZIPALIGN
    // )
                // }
            // }
        // }
    }
}